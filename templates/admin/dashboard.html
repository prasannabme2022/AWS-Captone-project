{% extends "base.html" %}

{% block content %}
<div class="glass-panel" style="max-width: 1200px; margin: 0 auto;">
    <h2 class="text-gradient" style="margin-bottom: 0.5rem;">Command Center</h2>
    <p style="color: #6b7280; margin-bottom: 2rem;">Real-time Hospital Resource Monitoring</p>

    <!-- Top Stats Row -->
    <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <!-- Blood Bank Widget -->
        <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e5e7eb;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0; color: #ef4444;"><i class="fas fa-burn"></i> Blood Bank</h3>
                <a href="{{ url_for('blood_bank_view') }}" style="font-size: 0.8rem; color: #ef4444;">Manage</a>
            </div>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                {% for group, data in blood_stock.items() %}
                <span
                    style="background: {{ '#fef2f2' if data.status != 'Available' else '#f0fdf4' }}; 
                             color: {{ '#dc2626' if data.status != 'Available' else '#16a34a' }}; 
                             padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: bold; border: 1px solid currentColor;">
                    {{ group }}: {{ data.units }}
                </span>
                {% endfor %}
            </div>
        </div>

        <!-- Capacity Widget -->
        <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e5e7eb;">
            <h3 style="margin: 0 0 1rem 0; color: #3b82f6;"><i class="fas fa-procedures"></i> Ward Capacity</h3>
            {% for ward, status in capacity.items() %}
            <div style="margin-bottom: 0.5rem; cursor: pointer;"
                onclick="openEditModal('{{ ward }}', '{{ status.occupied }}', '{{ status.total }}', '{{ status.status }}')">
                <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 0.2rem;">
                    <span>{{ ward }} <i class="fas fa-pen"
                            style="font-size: 0.7rem; color: #9ca3af; margin-left: 0.5rem;"></i></span>
                    <span style="font-weight: bold;">{{ status.occupied }}/{{ status.total }}</span>
                </div>
                <div style="background: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden;">
                    <div
                        style="background: {{ '#ef4444' if status.status == 'Critical' else '#3b82f6' }}; height: 100%; width: {{ (status.occupied / status.total) * 100 }}%;">
                    </div>
                </div>
            </div>
            {% endfor %}

            <!-- Edit Capacity Modal -->
            <div id="capacityModal"
                style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <form action="{{ url_for('update_capacity') }}" method="POST" class="glass-panel"
                    style="background: white; padding: 2rem; width: 300px;">
                    <h3 style="margin-top: 0;">Update Capacity</h3>
                    <input type="hidden" name="ward" id="edit-ward-name">

                    <div class="form-group">
                        <label class="form-label" id="edit-ward-label">Ward</label>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Occupied Beds</label>
                        <input type="number" name="occupied" id="edit-occupied" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select name="status" id="edit-status" class="form-input">
                            <option value="Normal">Normal</option>
                            <option value="High Load">High Load</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="button" onclick="document.getElementById('capacityModal').style.display='none'"
                            class="btn" style="flex: 1; background: #f3f4f6; color: #374151;">Cancel</button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Update</button>
                    </div>
                </form>
            </div>

            <script>
                function openEditModal(ward, occupied, total, status) {
                    document.getElementById('capacityModal').style.display = 'flex';
                    document.getElementById('edit-ward-name').value = ward;
                    document.getElementById('edit-ward-label').textContent = `${ward} (Total: ${total})`;
                    document.getElementById('edit-occupied').value = occupied;
                    document.getElementById('edit-occupied').max = total;
                    document.getElementById('edit-status').value = status;
                }
            </script>
            <!-- Department Load -->
            <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e5e7eb;">
                <h3 style="margin: 0 0 1rem 0; color: #8b5cf6;"><i class="fas fa-network-wired"></i> Quick Stats</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div style="text-align: center; padding: 1rem; background: #f9fafb; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #1f2937;">{{ patients|length }}</div>
                        <div style="font-size: 0.8rem; color: #6b7280;">Patients</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: #f9fafb; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #1f2937;">{{ dept_load.values()|sum }}
                        </div>
                        <div style="font-size: 0.8rem; color: #6b7280;">Active Appts</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Donations Widget (New Phase 7) -->
        <h3 style="margin-bottom: 1rem;">Pending Donations</h3>
        {% if pending_donations %}
        <div style="display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 1rem; margin-bottom: 2rem;">
            {% for don in pending_donations %}
            <div
                style="min-width: 200px; background: white; padding: 1rem; border-radius: 8px; border: 1px solid #e5e7eb; border-left: 4px solid #f59e0b;">
                <div style="font-weight: bold; color: #1f2937; margin-bottom: 0.25rem;">{{ don.donor }}</div>
                <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 0.5rem;">Group: <strong
                        style="color: #ef4444;">{{ don.group }}</strong></div>
                <div style="font-size: 0.8rem; color: #9ca3af; margin-bottom: 1rem;">{{ don.date }}</div>
                <a href="{{ url_for('verify_blood_donation', don_id=don.id) }}" class="btn btn-primary"
                    style="width: 100%; text-align: center; padding: 0.5rem;">
                    <i class="fas fa-check"></i> Verify & Stock
                </a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div
            style="padding: 1.5rem; background: #f0fdf4; color: #15803d; border-radius: 8px; margin-bottom: 2rem; border: 1px solid #bbf7d0;">
            <i class="fas fa-check-circle"></i> No pending donation requests.
        </div>
        {% endif %}

        <!-- Active Department Load -->
        <h3 style="margin-bottom: 1rem;">Department Load (Active)</h3>
        <div style="display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 1rem; margin-bottom: 2rem;">
            {% for dept, count in dept_load.items() %}
            <div
                style="min-width: 150px; background: white; padding: 1rem; border-radius: 8px; border: 1px solid #e5e7eb; text-align: center;">
                <div style="font-weight: bold; color: #4b5563;">{{ dept }}</div>
                <div style="font-size: 2rem; color: #8b5cf6; font-weight: 800;">{{ count }}</div>
                <div style="font-size: 0.8rem; color: #9ca3af;">Active</div>
            </div>
            {% endfor %}
            {% if not dept_load %}
            <div style="padding: 1rem; color: #6b7280;">No active appointments.</div>
            {% endif %}
        </div>

        <!-- Patient List -->
        <h3>Registered Patients</h3>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f3f4f6; text-align: left;">
                        <th style="padding: 1rem; border-radius: 8px 0 0 8px;">Name</th>
                        <th style="padding: 1rem;">Email</th>
                        <th style="padding: 1rem; border-radius: 0 8px 8px 0;">ID</th>
                    </tr>
                </thead>
                <tbody>
                    {% for patient in patients %}
                    <tr style="border-bottom: 1px solid #f3f4f6;">
                        <td style="padding: 1rem; font-weight: 500;">{{ patient.name }}</td>
                        <td style="padding: 1rem;">{{ patient.email }}</td>
                        <td style="padding: 1rem; color: #6b7280;">{{ patient.id }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endblock %}